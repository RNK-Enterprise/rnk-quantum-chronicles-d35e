import{CR}from"../lib.js";const api=foundry?.applications?.api,ApplicationV2=api?.ApplicationV2||class{},HandlebarsApplicationMixin=api?.HandlebarsApplicationMixin,CompendiumBrowserClass=HandlebarsApplicationMixin?HandlebarsApplicationMixin(ApplicationV2):ApplicationV2;export class CompendiumBrowser extends CompendiumBrowserClass{constructor(...e){super(...e),this.items=[],this.filters=[],this.activeFilters={},this._data={loaded:!1,data:{},promise:null}}loadData(){return new Promise((e=>{let t=this._data.promise;null==t&&(t=this._gatherData(),this._data.promise=t),t.then((()=>{this._data.loaded=!0,this._data.promise=null,e(this._data.data)}))}))}async _gatherData(){await this._fetchMetadata(),this._data.data={filters:this.filters,collection:this.items}}static get DEFAULT_OPTIONS(){return{id:"compendium-browser",classes:["compendium-browser-window"],window:{title:"Compendium Browser",resizable:!0},position:{width:720,height:800,top:30,left:40}}}static PARTS={content:{template:"systems/rnk-quantum-d35e/templates/apps/compendium-browser.html"}};get typeName(){switch(this.type){case"spells":return game.i18n.localize("D35E.Spells");case"items":return game.i18n.localize("D35E.Items");case"enhancements":return game.i18n.localize("D35E.Enhancements")}return this.type}get type(){return this.options.type}get title(){return[this.typeName,"Browser"].join(" ")}get entityType(){return this.options.entityType}async _fetchMetadata(){this.items=[];for(let e of game.packs.values()){if(e.private&&!game.user.isGM)continue;if((e.entity||e.documentName)!==this.entityType)continue;const t=await e.getDocuments();for(let s of t)this._filterItems(s)&&this.items.push(this._mapItem(e,s))}this.items.sort(((e,t)=>e.item.name<t.item.name?-1:e.item.name>t.item.name?1:0)),0!==this.items.length&&("spells"===this.type?this._fetchSpellFilters():"items"===this.type?this._fetchItemFilters():"bestiary"===this.type?this._fetchBestiaryFilters():"feats"===this.type?this._fetchFeatFilters():"enhancements"===this.type&&this._fetchEnhancementFilters(),this.activeFilters=this.filters.reduce(((e,t)=>(e[t.path]=[],e)),{}))}_filterItems(e){return!e.system.uniqueId&&(("spells"!==this.type||"spell"===e.type)&&(!("items"===this.type&&!["weapon","equipment","loot","consumable"].includes(e.type))&&(("feats"!==this.type||"feat"===e.type)&&(("buffs"!==this.type||"buff"===e.type)&&("enhancements"!==this.type||"enhancement"===e.type)))))}_mapItem(e,t){const s={collection:e.collection,item:{_id:t._id,name:t.name,type:t.type,img:t.img?.replace("systems/D35E/","systems/rnk-quantum-d35e/"),system:t.system||{},isSpell:"spell"===t.type}};if("enhancements"===this.type&&(this.extraFilters||(this.extraFilters={allowedTypes:[]}),s.item.allowedTypes=(getProperty(t,"system.allowedTypes")||[]).reduce(((e,t)=>(this.extraFilters.allowedTypes.includes(t[0])||this.extraFilters.allowedTypes.push(t[0]),e.push(t[0]),e)),[])),"feats"===this.type&&(this.extraFilters||(this.extraFilters={tags:[],associations:{class:[]}}),s.item.tags=(getProperty(t,"system.tags")||[]).reduce(((e,t)=>(this.extraFilters.tags.includes(t[0])||this.extraFilters.tags.push(t[0]),e.push(t[0]),e)),[]),s.item.assocations={class:("classFeat"===getProperty(t,"system.featType")&&getProperty(t,"system.assocations.classes")||[]).reduce(((e,t)=>(this.extraFilters["assocations.class"].includes(t[0])||this.extraFilters["assocations.class"].push(t[0]),e.push(t[0]),e)),[])}),"items"===this.type&&(this.extraFilters||(this.extraFilters={}),s.item.weaponProps=Object.entries(getProperty(t,"system.properties")||[]).reduce(((e,t)=>(t[1]&&e.push(t[0]),e)),[])),"spells"===this.type){this.extraFilters||(this.extraFilters={"learnedAt.class":[],"learnedAt.domain":[],"learnedAt.subDomain":[],"learnedAt.elementalSchool":[],"learnedAt.bloodline":[],"system.subschool":[],spellTypes:[]}),s.item.allSpellLevels=[],s.item.learnedAt={class:(getProperty(t,"system.learnedAt.class")||[]).reduce(((e,t)=>(this.extraFilters["learnedAt.class"].includes(t[0])||this.extraFilters["learnedAt.class"].push(t[0]),s.item.allSpellLevels.includes(t[1])||s.item.allSpellLevels.push(t[1]),e.push(t[0]),e)),[]),domain:(getProperty(t,"system.learnedAt.domain")||[]).reduce(((e,t)=>(this.extraFilters["learnedAt.domain"].includes(t[0])||this.extraFilters["learnedAt.domain"].push(t[0]),s.item.allSpellLevels.includes(t[1])||s.item.allSpellLevels.push(t[1]),e.push(t[0]),e)),[]),subDomain:(getProperty(t,"system.learnedAt.subDomain")||[]).reduce(((e,t)=>(this.extraFilters["learnedAt.subDomain"].includes(t[0])||this.extraFilters["learnedAt.subDomain"].push(t[0]),s.item.allSpellLevels.includes(t[1])||s.item.allSpellLevels.push(t[1]),e.push(t[0]),e)),[]),elementalSchool:(getProperty(t,"system.learnedAt.elementalSchool")||[]).reduce(((e,t)=>(this.extraFilters["learnedAt.elementalSchool"].includes(t[0])||this.extraFilters["learnedAt.elementalSchool"].push(t[0]),s.item.allSpellLevels.includes(t[1])||s.item.allSpellLevels.push(t[1]),e.push(t[0]),e)),[]),bloodline:(getProperty(t,"system.learnedAt.bloodline")||[]).reduce(((e,t)=>(this.extraFilters["learnedAt.bloodline"].includes(t[0])||this.extraFilters["learnedAt.bloodline"].push(t[0]),s.item.allSpellLevels.includes(t[1])||s.item.allSpellLevels.push(t[1]),e.push(t[0]),e)),[]),spellLevel:{class:(getProperty(t,"system.learnedAt.class")||[]).reduce(((e,t)=>(e[t[0]]=t[1],e)),{}),domain:(getProperty(t,"system.learnedAt.domain")||[]).reduce(((e,t)=>(e[t[0]]=t[1],e)),{}),subDomain:(getProperty(t,"system.learnedAt.subDomain")||[]).reduce(((e,t)=>(e[t[0]]=t[1],e)),{}),elementalSchool:(getProperty(t,"system.learnedAt.elementalSchool")||[]).reduce(((e,t)=>(e[t[0]]=t[1],e)),{}),bloodline:(getProperty(t,"system.learnedAt.bloodline")||[]).reduce(((e,t)=>(e[t[0]]=t[1],e)),{})}};{const e=getProperty(t,"system.subschool");e&&!this.extraFilters["system.subschool"].includes(e)&&this.extraFilters["system.subschool"].push(e)}{const e=getProperty(t,"system.types")?getProperty(t,"system.types").split(CONFIG.D35E.re.traitSeparator):[];s.item.spellTypes=e;for(let t of e)this.extraFilters.spellTypes.includes(t)||this.extraFilters.spellTypes.push(t)}}if("bestiary"===this.type&&(this.extraFilters||(this.extraFilters={"system.details.cr":[]}),"npc"===t.type)){const e=getProperty(t,"system.details.cr");e&&!this.extraFilters["system.details.cr"].includes(e)&&this.extraFilters["system.details.cr"].push(parseFloat(e))}return s}async getData(){return this._data.loaded||await this.loadData(),this._data.data}async refresh(){await this.loadData(),this.render(!1)}_fetchSpellFilters(){this.filters=[{path:"system.school",label:game.i18n.localize("D35E.SpellSchool"),items:Object.entries(CONFIG.D35E.spellSchools).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"system.subschool",label:game.i18n.localize("D35E.SubSchool"),items:this.extraFilters["system.subschool"].reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"spellTypes",label:game.i18n.localize("D35E.TypePlural"),items:this.extraFilters.spellTypes.reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"learnedAt.class",label:game.i18n.localize("D35E.ClassPlural"),items:this.extraFilters["learnedAt.class"].reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"learnedAt.domain",label:game.i18n.localize("D35E.Domain"),items:this.extraFilters["learnedAt.domain"].reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"learnedAt.subDomain",label:game.i18n.localize("D35E.SubDomain"),items:this.extraFilters["learnedAt.subDomain"].reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"learnedAt.bloodline",label:game.i18n.localize("D35E.Bloodline"),items:this.extraFilters["learnedAt.bloodline"].reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"_spellLevel",label:game.i18n.localize("D35E.SpellLevel"),items:Object.entries(CONFIG.D35E.spellLevels).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])}]}_fetchItemFilters(){this.filters=[{path:"type",label:game.i18n.localize("D35E.Type"),items:[{key:"weapon",name:game.i18n.localize("D35E.ItemTypeWeapon")},{key:"equipment",name:game.i18n.localize("D35E.ItemTypeEquipment")},{key:"consumable",name:game.i18n.localize("D35E.ItemTypeConsumable")},{key:"loot",name:game.i18n.localize("D35E.Misc")}]},{path:"system.weaponType",label:game.i18n.localize("D35E.WeaponType"),items:Object.entries(CONFIG.D35E.weaponTypes).reduce(((e,t)=>(e.push({key:t[0],name:t[1]._label}),e)),[])},{path:"system.weaponSubtype",label:game.i18n.localize("D35E.WeaponSubtype"),items:Object.values(CONFIG.D35E.weaponTypes).reduce(((e,t)=>t&&"object"==typeof t?e=e.concat(Object.entries(t).filter((e=>e[0]&&"string"==typeof e[0]&&!e[0].startsWith("_"))).reduce(((t,s)=>(e.filter((e=>e.key===s[0])).length||t.push({key:s[0],name:s[1]}),t)),[])):e),[])},{path:"weaponProps",label:game.i18n.localize("D35E.WeaponProperties"),items:Object.entries(CONFIG.D35E.weaponProperties).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])},{path:"system.equipmentType",label:game.i18n.localize("D35E.EquipmentType"),items:Object.entries(CONFIG.D35E.equipmentTypes).reduce(((e,t)=>(e.push({key:t[0],name:t[1]._label}),e)),[])},{path:"system.equipmentSubtype",label:game.i18n.localize("D35E.EquipmentSubtype"),items:Object.values(CONFIG.D35E.equipmentTypes).reduce(((e,t)=>t&&"object"==typeof t?e=e.concat(Object.entries(t).filter((e=>e[0]&&"string"==typeof e[0]&&!e[0].startsWith("_"))).reduce(((t,s)=>(e.filter((e=>e.key===s[0])).length||t.push({key:s[0],name:s[1]}),t)),[])):e),[])},{path:"system.slot",label:game.i18n.localize("D35E.Slot"),items:Object.values(CONFIG.D35E.equipmentSlots).reduce(((e,t)=>t&&"object"==typeof t?e=e.concat(Object.entries(t).filter((e=>e[0]&&"string"==typeof e[0]&&!e[0].startsWith("_"))).reduce(((t,s)=>(e.filter((e=>e.key===s[0])).length||t.push({key:s[0],name:s[1]}),t)),[])):e),[])},{path:"system.consumableType",label:game.i18n.localize("D35E.ConsumableType"),items:Object.entries(CONFIG.D35E.consumableTypes).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])},{path:"system.subType",label:game.i18n.localize("D35E.Misc"),items:Object.entries(CONFIG.D35E.lootTypes).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])}]}_fetchBestiaryFilters(){this.filters=[{path:"system.details.cr",label:"CR",items:this.extraFilters["system.details.cr"].sort((function(e,t){return e-t})).reduce(((e,t)=>(e.push({key:t,name:CR.fromNumber(t)}),e)),[])},{path:"system.attributes.creatureType",label:game.i18n.localize("D35E.CreatureType"),items:Object.entries(CONFIG.D35E.creatureTypes).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])}]}_fetchEnhancementFilters(){this.filters=[{path:"system.enhancementType",label:game.i18n.localize("D35E.Type"),items:Object.entries(CONFIG.D35E.enhancementType).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])},{path:"allowedTypes",label:game.i18n.localize("D35E.EnhancementAllowedTypes"),items:this.extraFilters.allowedTypes.reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))}]}_fetchFeatFilters(){this.filters=[{path:"system.featType",label:game.i18n.localize("D35E.Type"),items:Object.entries(CONFIG.D35E.featTypes).reduce(((e,t)=>(e.push({key:t[0],name:t[1]}),e)),[])},{path:"tags",label:game.i18n.localize("D35E.Tags"),items:this.extraFilters.tags.reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))},{path:"assocations.class",label:game.i18n.localize("D35E.ClassPlural"),items:this.extraFilters.associations.class.reduce(((e,t)=>(e.push({key:t,name:t}),e)),[]).sort(((e,t)=>e.name>t.name?1:e.name<t.name?-1:0))}]}async _render(...e){await super._render(...e),this.filterQuery=/.*/,this.element.find(".filter-content").css("display","none")}activateListeners(e){super.activateListeners(e),e.find(".entry-name").click((e=>{let t=e.currentTarget.parentElement.parentElement;this._onEntry(t.getAttribute("data-collection"),t.getAttribute("data-entry-id"))})),e.find(".directory-item").each(((e,t)=>{t.setAttribute("draggable",!0),t.addEventListener("dragstart",this._onDragStart,!1)})),e.find('input[name="search"]').keyup(this._onFilterResults.bind(this)),e.find('input[name="search"]').focus(),e.find('.filter input[type="checkbox"]').change(this._onActivateBooleanFilter.bind(this)),e.find(".filter h3").click(this._toggleFilterVisibility.bind(this)),e.find("button.refresh").click(this.refresh.bind(this))}async _onEntry(e,t){const s=game.packs.find((t=>t.collection===e));(await s.getDocument(t)).sheet.render(!0)}_onDragStart(e){const t=this.getAttribute("data-collection"),s=game.packs.find((e=>e.collection===t));if(!s)return e.preventDefault(),!1;e.dataTransfer.setData("text/plain",JSON.stringify({type:s.entity||s.documentName,pack:s.collection,id:this.getAttribute("data-entry-id")}))}_toggleFilterVisibility(e){e.preventDefault();const t=e.currentTarget,s=$(t).siblings(".filter-content")[0];"none"===s.style.display?s.style.display="block":s.style.display="none"}_onFilterResults(e){e.preventDefault();let t=e.currentTarget,s=e=>{this.filterQuery=e,this._filterResults()},i=new RegExp(RegExp.escape(t.value),"i");this._filterTimeout&&(clearTimeout(this._filterTimeout),this._filterTimeout=null),this._filterTimeout=setTimeout((()=>s(i)),100)}_onActivateBooleanFilter(e){e.preventDefault();let t=e.currentTarget;const s=t.closest(".filter").dataset.path,i=t.name;if(t.checked){this.activeFilters[s].indexOf(i)<0&&this.activeFilters[s].push(i)}else{let e=this.activeFilters[s].indexOf(i);e>=0&&this.activeFilters[s].splice(e,1)}this._filterResults()}_filterResults(){this.element.find("li.directory-item").each(((e,t)=>{const s=t.dataset.entryId;let i=this.items.find((e=>e.item._id===s)).item;t.style.display=this._passesFilters(i)?"flex":"none"}))}_passesFilters(e){if(!this.filterQuery.test(e.name))return!1;for(let[t,s]of Object.entries(this.activeFilters)){if(0===s.length)continue;{let s=null;if("spells"===this.type&&"_spellLevel"===t){s=!1;let i=!1;const a=this.activeFilters[t],l=[{path:"learnedAt.class",type:"class"},{path:"learnedAt.domain",type:"domain"},{path:"learnedAt.subDomain",type:"subDomain"},{path:"learnedAt.elementalSchool",type:"elementalSchool"},{path:"learnedAt.bloodline",type:"bloodline"}];for(let t of l){const l=this.activeFilters[t.path];if(l&&l.length){i=!0;for(let i of l){const l=getProperty(e,`learnedAt.spellLevel.${t.type}`);for(let e of a)l[i]===parseInt(e)&&(s=!0)}}}if(!i)for(let t of a)e.allSpellLevels.includes(parseInt(t))&&(s=!0)}if(!1===s)return!1;if(!0===s)continue}const i=getProperty(e,t);if(null==i)return!1;if("number"==typeof i&&(s=s.map((e=>parseFloat(e))).filter((e=>!isNaN(e)))),i instanceof Array){if(!s.every((e=>i.includes(e))))return!1}else if(!s.includes(i))return!1}return!0}}