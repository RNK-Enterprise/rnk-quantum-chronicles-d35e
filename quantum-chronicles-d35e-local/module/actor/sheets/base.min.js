import{ActorTraitSelector}from"../../apps/trait-selector.js";import{DicePF}from"../../dice.js";import{D35E}from"../../config.js";import{SYSTEM_ID}from"../../settings.js";const api=foundry?.applications?.api,sheets=foundry?.applications?.sheets,V2Base=api?.ActorSheetV2||api?.DocumentSheetV2||api?.ApplicationV2||sheets?.ActorSheetV2,BaseClass=V2Base||globalThis?.ActorSheet||class{},ActorSheetClass=V2Base&&api?.HandlebarsApplicationMixin?api.HandlebarsApplicationMixin(BaseClass):BaseClass;export class ActorSheetPF extends ActorSheetClass{static get DEFAULT_OPTIONS(){return{classes:["rnk-quantum-d35e","sheet","actor"],window:{resizable:!0,minimizable:!0},position:{width:1200,height:900}}}static get PARTS(){return{sheet:{tag:"form",template:"systems/rnk-quantum-d35e/templates/actors/actor-sheet.hbs",classes:["actor-sheet"]}}}async _prepareContext(t={}){this.tabGroups||(this.tabGroups={}),this.tabGroups.primary||("npc"===this.actor.type?this.tabGroups.primary="stats":this.tabGroups.primary="abilities");return{actor:this.actor,system:this.actor.system,items:this.actor.items,config:D35E,cssClass:this.options.classes.join(" "),quantumEntropy:Math.random(),activeTab:this.tabGroups.primary}}async getData(t={}){return await this._prepareContext(t)}_onTabClick(t){t.preventDefault();const e=t.currentTarget.dataset.tab,a=this.element instanceof HTMLElement?this.element:this.element[0];this.tabGroups||(this.tabGroups={}),this.tabGroups.primary=e,a.querySelectorAll(".sheet-tabs button").forEach((t=>t.classList.remove("active"))),a.querySelectorAll(".tab").forEach((t=>t.classList.remove("active"))),t.currentTarget.classList.add("active");const s=a.querySelector(`.tab[data-tab="${e}"]`);s&&s.classList.add("active");const r=a.querySelector(".sheet-body");r&&(r.scrollTop=0),this._tabs?.[0]&&this._tabs[0].activate(e)}async _onRender(t,e){const a=this.element instanceof HTMLElement?this.element:this.element[0],s=this.tabGroups?.primary;s&&(a.querySelector(`.sheet-tabs button[data-tab="${s}"]`)?.classList.add("active"),a.querySelector(`.tab[data-tab="${s}"]`)?.classList.add("active"),a.querySelectorAll(`.sheet-tabs button:not([data-tab="${s}"])`).forEach((t=>t.classList.remove("active"))),a.querySelectorAll(`.tab:not([data-tab="${s}"])`).forEach((t=>t.classList.remove("active")))),this._activateSheetListeners(a),this._setupDragAndDrop(a)}_setupDragAndDrop(t){this._dragHandlers||(this._dragHandlers={dragstart:t=>this._onDragStart(t),dragover:t=>{t.preventDefault(),t.dataTransfer.dropEffect="copy"},drop:t=>this._onDrop(t)});t.querySelectorAll(".item[data-item-id]").forEach((t=>{t.removeEventListener("dragstart",this._dragHandlers.dragstart),t.draggable=!1}));const e=t.closest("form")||t;e&&this._formElement&&this._formElement!==e&&(this._formElement.removeEventListener("dragover",this._dragHandlers.dragover),this._formElement.removeEventListener("drop",this._dragHandlers.drop));t.querySelectorAll(".item[data-item-id]").forEach((t=>{t.draggable=!0,t.addEventListener("dragstart",this._dragHandlers.dragstart)})),e&&(e.addEventListener("dragover",this._dragHandlers.dragover),e.addEventListener("drop",this._dragHandlers.drop),this._formElement=e)}activateListeners(t){super.activateListeners(t),this._activateSheetListeners(t)}_activateSheetListeners(t){const e=t instanceof HTMLElement?t:t[0]||t.get(0);e.addEventListener("click",(t=>{const e=t.target.closest(".rollable, [data-roll-type]");if(!e)return;t.preventDefault(),t.stopPropagation();const a=e.dataset.rollType;e.dataset.ability||e.dataset.save||e.dataset.skill;if("ability"===a&&e.dataset.ability)return this._onAbilityCheck({...t,target:{dataset:{ability:e.dataset.ability}},preventDefault:()=>{},stopPropagation:()=>{}});if("save"===a&&e.dataset.save)return this._onSaveRoll({...t,target:{dataset:{save:e.dataset.save}},preventDefault:()=>{},stopPropagation:()=>{}});if("skill"===a&&e.dataset.skill)return this._onSkillCheck({...t,target:{dataset:{skill:e.dataset.skill}},preventDefault:()=>{},stopPropagation:()=>{}});if("initiative"===a){if("function"==typeof this.actor.rollInitiative)return this.actor.rollInitiative({event:t})}else if("bab"===a&&"function"==typeof this.actor.rollBAB)return this.actor.rollBAB({event:t})}),!0),e.querySelectorAll(".sheet-tabs button, .sheet-tabs .tab-btn").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.dataset.tab;this._tabs?.[0]?this._tabs[0].activate(e):this._onTabClick(t)}))})),e.addEventListener("click",(t=>{t.target.matches(".item .item-name h4")&&this._onItemRoll(t)})),e.addEventListener("click",(t=>{t.target.matches(".ability-check, .ability-name, .ability, .ability-square, .ability-title")&&this._onAbilityCheck(t)})),e.addEventListener("click",(t=>{t.target.matches(".save-roll, .saving-throw, .saves-panel strong")&&this._onSaveRoll(t)})),e.addEventListener("click",(t=>{if(t.target.matches(".stat-summary strong")){const e=t.target.textContent.trim().toLowerCase();"bab"===e?this.actor.rollBAB({event:t}):"init"===e&&this.actor.rollInitiative({event:t})}})),e.addEventListener("click",(t=>{if(t.target.matches('.skill-name, [data-roll-type="skill"]')){t.preventDefault(),t.stopPropagation();let e=t.target.dataset.skill;if(e||(e=t.target.textContent.trim().toLowerCase()),e&&"function"==typeof this.actor.rollSkill)return void this.actor.rollSkill(e,{event:t});this._onSkillCheck.call(this,t)}})),e.addEventListener("click",(t=>{if(t.target.matches("input, label, .skill-rank"))return;const e=t.target.closest(".skill, .sub-skill, .skill-row");if(!e)return;const a=e.querySelector(".skill-roll");a?(t.preventDefault(),t.stopPropagation(),a.click()):this._onSkillCheck.call(this,t)})),e.addEventListener("click",(t=>{if(t.target.matches(".ability, .ability-square")){if(t.target.closest("input, button, .controls"))return;t.preventDefault(),t.stopPropagation();const e=t.target.querySelector(".ability-name, .ability-title");e&&e.click()}})),e.addEventListener("click",(t=>{if(t.target.matches(".saving-throw, .saves-panel div")){if(t.target.closest("input, button, .controls"))return;if(t.target.matches("strong"))return;t.preventDefault(),t.stopPropagation();const e=t.target.querySelector(".attribute-name, strong");e&&e.click()}})),e.addEventListener("click",(t=>{if(t.target.matches(".skill-name, .skill .skill-total")){t.preventDefault(),t.stopPropagation();const e=t.target.closest(".skill, .sub-skill, .skill-row");if(!e)return;const a=e.querySelector(".skill-roll");a&&a.click()}})),e.addEventListener("click",(async t=>{if(!t.target.matches(".item-control"))return;const e=t.target;if(e.classList.contains("item-create"))return this._onItemCreate.call(this,t);const a=e.closest(".item");if(!a)return;const s=a.dataset.itemId;if(s)if(e.classList.contains("item-edit"))this._onItemEdit.call(this,t);else if(e.classList.contains("item-delete"))this._onItemDelete.call(this,t);else if(e.classList.contains("item-roll")){const t=this.actor.items.get(s);if(!t)return;try{"function"==typeof t.roll?await t.roll(this.actor):"function"==typeof t.toMessage&&await t.toMessage()}catch(e){ui.notifications.error(`Error rolling ${t.name}: ${e.message}`)}}}))}async _onItemCreate(t){t.preventDefault(),t.stopPropagation();const e=t.currentTarget,a=e.dataset.type;if(!a)return;const s={name:`New ${a.charAt(0).toUpperCase()+a.slice(1)}`,type:a,system:structuredClone(e.dataset)};return delete s.system.type,this.actor.createEmbeddedDocuments("Item",[s])}_onItemEdit(t){t.preventDefault(),t.stopPropagation();const e=t.currentTarget.closest(".item");if(!e)return;const a=e.dataset.itemId;if(!a)return;const s=this.actor.items.get(a);s&&s.sheet.render(!0)}async _onItemDelete(t){t.preventDefault(),t.stopPropagation();const e=t.currentTarget.closest(".item");if(!e)return;const a=e.dataset.itemId;return a&&this.actor.items.get(a)?t.shiftKey?this.actor.deleteEmbeddedDocuments("Item",[a]):Dialog.confirm({title:game.i18n.localize("D35E.DeleteItem"),content:`<p>${game.i18n.localize("D35E.DeleteItemConfirmation")}</p>`,yes:async()=>{this.actor.items.get(a)&&await this.actor.deleteEmbeddedDocuments("Item",[a])},no:()=>{},defaultYes:!1}):void 0}_onItemRoll(t){t.preventDefault(),t.stopPropagation();const e=t.currentTarget.closest(".item")?.dataset.itemId;if(!e)return;const a=this.actor.items.get(e);a&&("function"==typeof a.roll?a.roll():a&&a.toMessage())}_onAbilityCheck(t){t.preventDefault(),t.stopPropagation();let e=t.currentTarget.dataset.ability;if(!e){e=t.currentTarget.closest("[data-ability]")?.dataset.ability}if(!e){const a=(t.currentTarget.textContent||"").trim().toLowerCase();e={strength:"str",dexterity:"dex",constitution:"con",intelligence:"int",wisdom:"wis",charisma:"cha"}[a]||(a?a.substring(0,3):null)}e&&"function"==typeof this.actor.rollAbilityTest?this.actor.rollAbilityTest(e,{event:t}):e&&"function"==typeof this.actor.rollAbilityCheck&&this.actor.rollAbilityCheck({ability:e,event:t})}_onSaveRoll(t){t.preventDefault(),t.stopPropagation();let e=t.currentTarget.dataset.save;if(!e){e=t.currentTarget.closest("[data-save]")?.dataset.save}if(!e){const a=(t.currentTarget.textContent||"").trim().toLowerCase();e={fortitude:"fort",reflex:"ref",will:"will"}[a]||(a?a.substring(0,4):null)}e&&"function"==typeof this.actor.rollSave?this.actor.rollSave(e,{event:t}):e&&"function"==typeof this.actor.rollAbilitySave&&this.actor.rollAbilitySave(e,{event:t})}_onSkillCheck(t){t.preventDefault(),t.stopPropagation();let e=t.currentTarget.dataset.skill;if(!e&&t.currentTarget.closest("[data-skill]")&&(e=t.currentTarget.closest("[data-skill]").dataset.skill),!e){e=t.currentTarget.closest(".skill, .sub-skill, .skill-row")?.dataset.skill}e||(e=t.currentTarget.textContent.trim().toLowerCase()),e&&"function"==typeof this.actor.rollSkill&&this.actor.rollSkill(e,{event:t})}async _onDrop(t){let e;t.preventDefault(),t.stopPropagation();try{e=(foundry.applications.ux?.TextEditor?.implementation||TextEditor).getDragEventData(t)}catch(t){return}if(e){switch(e.type){case"Item":return this._onDropItem(t,e);case"Actor":return this._onDropActor(t,e);case"Folder":return this._onDropFolder(t,e)}return super._onDrop?super._onDrop(t):void 0}}_onDragStart(t){const e=t.target.closest(".item")||t.target;if(!e)return;const a=e.getAttribute("data-item-id");if(!a)return;const s=this.actor.items.get(a);if(!s)return;const r=s.toDragData();r&&(t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",JSON.stringify(r)))}async _onDropItem(t,e){if(!this.actor.isOwner)return!1;const a=(await Item.fromDropData(e)).toObject();return this.actor.createEmbeddedDocuments("Item",[a])}async _onDropActor(t,e){if(!this.actor.isOwner)return!1}async _onDropFolder(t,e){if(!this.actor.isOwner)return!1}async _onSubmit(t,e,a){e.preventDefault()}_onAbilityCheck(t){t.preventDefault(),t.stopPropagation();const e=t.target.dataset.ability||t.target.closest("[data-ability]")?.dataset.ability;e&&"function"==typeof this.actor.rollAbilityTest&&this.actor.rollAbilityTest(e,{event:t})}_onSaveRoll(t){t.preventDefault(),t.stopPropagation();const e=t.target.dataset.save||t.target.closest("[data-save]")?.dataset.save;e&&"function"==typeof this.actor.rollSavingThrow&&this.actor.rollSavingThrow(e,{event:t})}_onSkillCheck(t){t.preventDefault(),t.stopPropagation();const e=t.target.dataset.skill||t.target.closest("[data-skill]")?.dataset.skill;e&&"function"==typeof this.actor.rollSkill&&this.actor.rollSkill(e,{event:t})}_onItemRoll(t){t.preventDefault(),t.stopPropagation();const e=t.target.closest("[data-item-id]");if(!e)return;const a=e.dataset.itemId,s=this.actor.items.get(a);s&&("function"==typeof s.roll?s.roll(this.actor):"function"==typeof s.toMessage&&s.toMessage({},{rollMode:game.settings.get("core","rollMode")}))}async _onItemCreate(t){t.preventDefault();const e=t.currentTarget.closest(".item-controls")?.dataset.itemType||"equipment";return await this.actor.createEmbeddedDocuments("Item",[{name:`New ${e.charAt(0).toUpperCase()+e.slice(1)}`,type:e}])}_onItemEdit(t){t.preventDefault(),t.stopPropagation();const e=t.target.closest("[data-item-id]");if(!e)return;const a=e.dataset.itemId,s=this.actor.items.get(a);s&&s.sheet.render(!0)}_onItemDelete(t){t.preventDefault(),t.stopPropagation();const e=t.target.closest("[data-item-id]");if(!e)return;const a=e.dataset.itemId;this.actor.deleteEmbeddedDocuments("Item",[a])}}