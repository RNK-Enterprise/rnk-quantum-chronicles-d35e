// @ts-nocheck
export class SpellSlotManager{constructor(s){this.actor=s,this.initializeSlots()}initializeSlots(){this.actor.system.spellSlots||(this.actor.system.spellSlots={});for(let s=0;s<=9;s++)this.actor.system.spellSlots[s]||(this.actor.system.spellSlots[s]={value:0,max:0,prepared:[]})}getSlots(s){return this.actor.system.spellSlots[s]||{value:0,max:0,prepared:[]}}setSlots(s,e){this.actor.system.spellSlots[s].max=e,this.actor.system.spellSlots[s].value=e}expendSlot(s){const e=this.getSlots(s);return e.value>0&&(e.value--,!0)}restoreSlot(s){const e=this.getSlots(s);return e.value<e.max&&(e.value++,!0)}prepareSpell(s){const e=this.actor.items.get(s);if(!e||"spell"!==e.type)return!1;const t=e.system.level||0,l=this.getSlots(t);return!l.prepared.includes(s)&&(l.prepared.push(s),!0)}unprepareSpell(s){const e=this.actor.items.get(s);if(!e)return!1;const t=e.system.level||0,l=this.getSlots(t);return l.prepared=l.prepared.filter(e=>e!==s),!0}isPrepared(s){const e=this.actor.items.get(s);if(!e)return!1;const t=e.system.level||0;return this.getSlots(t).prepared.includes(s)}getSpellDC(s,e=0){return 10+s+e}calculateBonusSpells(s){const e={};for(let t=1;t<=9;t++){const l=Math.max(0,Math.floor((s-t)/4)+1);e[t]=l}return e}getPreparedSpellsOfLevel(s){return this.getSlots(s).prepared.map(s=>this.actor.items.get(s)).filter(e=>e&&e.system.level===s)}getAvailableSpellsOfLevel(s){return this.actor.items.filter(e=>"spell"===e.type&&e.system.level===s)}}export class SpellActivity{constructor(s){this.spell=s,this.name=s.name,this.level=s.system.level||0,this.school=s.system.school||"abjuration",this.components=s.system.components||{verbal:!0,somatic:!0,material:!1},this.castingTime=s.system.castingTime||"1 action",this.range=s.system.range||"Self",this.duration=s.system.duration||"Instantaneous",this.description=s.system.description?.value||""}async cast(s,e={}){console.log(`Casting ${this.spell.name}`,{actor:s.name,config:e});const t=s._spellSlotManager;if(!t)return console.error("No spell slot manager found on actor"),null;if(this.level>0&&!t.expendSlot(this.level))return console.warn(`No spell slots available for level ${this.level}`),null;return await this.createSpellMessage(s,e)}async createSpellMessage(s,e={}){const t=this.calculateDC(s),l=this.formatComponents(),a=`\n      <div class="spell-cast-message">\n        <div class="spell-header">\n          <h2>${this.spell.name}</h2>\n          <div class="spell-meta">\n            <span class="spell-level">Level ${this.level}</span>\n            <span class="spell-school">${this.school}</span>\n          </div>\n        </div>\n        \n        <div class="spell-details">\n          <div class="detail-row">\n            <span class="label">Casting Time:</span>\n            <span class="value">${this.castingTime}</span>\n          </div>\n          <div class="detail-row">\n            <span class="label">Range:</span>\n            <span class="value">${this.range}</span>\n          </div>\n          <div class="detail-row">\n            <span class="label">Duration:</span>\n            <span class="value">${this.duration}</span>\n          </div>\n          <div class="detail-row">\n            <span class="label">Components:</span>\n            <span class="value">${l}</span>\n          </div>\n          ${this.level>0?`\n          <div class="detail-row">\n            <span class="label">Save DC:</span>\n            <span class="value">${t}</span>\n          </div>\n          `:""}\n        </div>\n\n        <div class="spell-description">\n          <p>${this.description}</p>\n        </div>\n\n        <div class="spell-actions">\n          <button class="spell-concentration" data-spell-id="${this.spell.id}">\n            Maintain Concentration\n          </button>\n        </div>\n      </div>\n    `,n={user:game.user.id,speaker:ChatMessage.getSpeaker({actor:s}),content:a,flags:{"rnk-quantum-d35e":{spellId:this.spell.id,spellLevel:this.level,spellDC:t}}};return ChatMessage.create(n)}calculateDC(s){const e=config.spellcasterAbility||"int",t=this.spell.system.spellcasterAbility||e,l=s.system.abilities[t]?.mod||0;return 10+this.level+l}formatComponents(){const s=[];return this.components.verbal&&s.push("V"),this.components.somatic&&s.push("S"),this.components.material&&s.push("M"+(this.components.materialComponent?` (${this.components.materialComponent})`:"")),s.join(", ")}}