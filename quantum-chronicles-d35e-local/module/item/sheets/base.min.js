import{D35E}from"../../config.js";const api=foundry?.applications?.api,sheets=foundry?.applications?.sheets,V2Base=api?.ItemSheetV2||api?.DocumentSheetV2||api?.ApplicationV2||sheets?.ItemSheetV2,BaseClass=V2Base||globalThis?.ItemSheet||class{},ItemSheetClass=V2Base&&api?.HandlebarsApplicationMixin?api.HandlebarsApplicationMixin(BaseClass):BaseClass;export class ItemSheetPF extends ItemSheetClass{get item(){return this.document}static get DEFAULT_OPTIONS(){return{classes:["rnk-quantum-d35e","sheet","item"],window:{resizable:!0,minimizable:!0},position:{width:800,height:720}}}static get PARTS(){return{sheet:{tag:"form",template:"systems/rnk-quantum-d35e/templates/items/item-sheet.hbs",classes:["item-sheet"]}}}get template(){return"spell"===(this.document??this.object)?.type?"systems/rnk-quantum-d35e/templates/items/spell-sheet.hbs":"systems/rnk-quantum-d35e/templates/items/item-sheet.hbs"}async getData(t={}){const e=await super.getData(t);return e.item=this.item,e.system=this.item.system,e.type=this.item.type,e.config=D35E,e.fractalTree=this.buildFractalDisplay(),e.activities=this.item.activities||[],e.effects=this.item.effects.contents,e}async _prepareContext(t){const e=await super._prepareContext(t),i=this.document??this.object;return i?(e.item=i,e.system=i.system,e.type=i.type,e.config=D35E,e.fractalTree=i.fractalRoot?this.serializeFractal(i.fractalRoot):{},e.activities=i.activities||[],e.effects=i.effects?.contents||[],e):e??{}}_configureRenderOptions(t){super._configureRenderOptions(t);"spell"===(this.document??this.item)?.type&&this.constructor.PARTS?.sheet&&(this.constructor.PARTS.sheet.template="systems/rnk-quantum-d35e/templates/items/spell-sheet.hbs")}_onRender(t,e){super._onRender(t,e),this._activateCustomListeners($(this.element))}_activateCustomListeners(t){const e=t.find(".item-sheet-container").length?t.find(".item-sheet-container"):t;e.find(".add-change").click(this._onAddChange.bind(this)),e.find(".delete-change").click(this._onDeleteChange.bind(this)),e.find(".roll-item").click(this._onRoll.bind(this)),e.find(".add-activity").click(this._onAddActivity.bind(this)),e.find(".delete-activity").click(this._onDeleteActivity.bind(this)),e.find(".roll-activity").click(this._onRollActivity.bind(this)),e.find(".add-effect").click(this._onAddEffect.bind(this)),e.find(".edit-effect").click(this._onEditEffect.bind(this)),e.find(".delete-effect").click(this._onDeleteEffect.bind(this))}async _onAddActivity(t){t.preventDefault();const e=Array.from(this.item.system.activities||[]);return e.push({name:"New Activity",type:"attack",activation:{type:"action",cost:1}}),this.item.update({"system.activities":e})}async _onDeleteActivity(t){t.preventDefault();const e=t.currentTarget.closest(".activity-item"),i=parseInt(e.dataset.activityId),s=Array.from(this.item.system.activities||[]);return s.splice(i,1),this.item.update({"system.activities":s})}async _onRollActivity(t){t.preventDefault();const e=parseInt(t.currentTarget.dataset.activityId),i=this.item.activities[e];if(i)return i.execute(this.item.actor||game.user.character)}async _onAddEffect(t){return t.preventDefault(),ActiveEffect.create({name:"New Effect",img:"icons/svg/aura.svg",origin:this.item.uuid,disabled:!1},{parent:this.item}).then((t=>t.sheet.render(!0)))}async _onEditEffect(t){t.preventDefault();const e=t.currentTarget.closest(".effect-item");this.item.effects.get(e.dataset.effectId).sheet.render(!0)}async _onDeleteEffect(t){t.preventDefault();const e=t.currentTarget.closest(".effect-item");return this.item.effects.get(e.dataset.effectId).delete()}buildFractalDisplay(){const t=this.document??this.object;return t?.fractalRoot?this.serializeFractal(t.fractalRoot):{}}serializeFractal(t){return{data:t.data,children:t.children.map((t=>this.serializeFractal(t)))}}activateListeners(t){super.activateListeners(t),t.find(".roll-item").click(this._onRoll.bind(this)),t.find(".add-change").click(this._onAddChange.bind(this)),t.find(".delete-change").click(this._onDeleteChange.bind(this))}async _onAddChange(t){t.preventDefault();const e=Array.from(this.item.system.changes||[]);return e.push({formula:"0",target:"abilities.str.value",type:"untyped"}),this.item.update({"system.changes":e})}async _onDeleteChange(t){t.preventDefault();const e=t.currentTarget.closest(".change-row"),i=parseInt(e.dataset.index),s=Array.from(this.item.system.changes||[]);return s.splice(i,1),this.item.update({"system.changes":s})}_onRoll(t){t.preventDefault(),this.item.roll()}async _onSubmit(t,e,i){e.preventDefault()}}