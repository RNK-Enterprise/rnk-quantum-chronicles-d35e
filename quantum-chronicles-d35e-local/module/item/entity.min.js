// @ts-nocheck
import{ItemActivity,WeaponActivity,SpellActivity}from"./activities.js";class FractalItemNode{constructor(t,e=null){this.data=t,this.parent=e,this.children=[],e&&e.children.push(this)}traverse(t){t(this),this.children.forEach(e=>e.traverse(t))}addChild(t){return new FractalItemNode(t,this)}addEnhancement(t){return new FractalItemNode({type:"enhancement",...t},this)}calculateTotal(){let t=this.data.value||0;return this.children.forEach(e=>{t+=e.calculateTotal()}),t}}export class ItemPF extends Item{constructor(...t){super(...t),this.activities=[]}prepareData(){super.prepareData(),this.buildFractalTree(),this.initializeActivities()}buildFractalTree(){this.fractalRoot=new FractalItemNode({type:"item",id:this.id||"new-item",name:this.name||"New Item"});const t=this.system;t&&(this.fractalRoot.addChild({type:"properties",data:t}),Array.isArray(t.enhancements)&&t.enhancements.forEach(t=>{this.fractalRoot.addEnhancement(t)}),t.totalValue=this.fractalRoot.calculateTotal())}initializeActivities(){switch(this.activities=[],this.type){case"weapon":this.activities.push(new WeaponActivity(this));break;case"spell":this.activities.push(new SpellActivity(this));break;case"feat":this.system?.actionType&&this.activities.push(new ItemActivity(this,{name:`Use ${this.name}`,type:"ability"}))}}getActivities(){return this.activities}getActivity(t){return this.activities.find(e=>e.type===t)}async roll(t=null,e={}){if(!t&&game.canvas?.tokens?.controlled?.[0]&&(t=game.canvas.tokens.controlled[0].actor),!t)return ui.notifications.warn("No actor selected to perform this action"),null;const i=this.activities[0];return i?i.execute(t,e):this.toMessage()}getRollData(){const t=super.getRollData();return t.fractalBonus=.1*this.fractalRoot.calculateTotal(),t}}